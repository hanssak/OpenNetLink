@inherits LayoutComponentBase
@using OpenNetLinkApp.Data.SGDicData.SGUnitData
@using OpenNetLinkApp.PageEvent
@using HsNetWorkSG
@inject HSCmdCenter HsCmdCenter
@inject ISGAppManagerService SGAppMgrSvc
@inject XmlConfService XmlConf
@inject WebWindow Window
@inject NavigationManager MyNavigationManager
@inject ISGAppUpdaterService AppUpdaterSvc;
<!-- Navbar -->
<nav id="main-nav" class="main-header navbar navbar-expand navbar-white navbar-light text-md navbar-default border-0">
    <HeaderUI />
</nav>
<!-- /.Navbar -->
<!-- Main Sidebar Container -->
<aside id="left-sidebar" class="main-sidebar sidebar-dark-primary elevation-4" style="background-image: url('/images/adminlte/slide_bg_1.png');background-position:right bottom; background-size: cover;">
    <!-- Brand Logo -->
    <a href="/Welcome" class="brand-link border-0 m-0 p-0 text-center">
        <img src="/images/adminlte/logo_l.png" alt=" Logo" class="brand-text float-left">
    </a>
    <a href="/Welcome" class="brand-link border-0">
        <img src="/images/adminlte/logo_s.png" alt="Logo" class="logo-xs">
    </a>
    <!-- /.Brand Logo -->

    <SideBarUI />
</aside>
<!-- /.Main Sidebar Container -->
<!-- Content Wrapper. Contains page content -->
<div id="main-body" class="content-wrapper">
    @Body
    <LogIn_DisplayLock></LogIn_DisplayLock>
    <!--<SGNotiDownloadUpdate @ref="refSGNotiDownloadUpdate" CtrlSideUISvc="@CtrlSideUISvc" OnCancelDownloadUpdate="CloseDownloadUpdate"></SGNotiDownloadUpdate>-->
</div>
<!-- /.Content-Wrapper -->
<!-- Control Sidebar -->
<aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
    <CtrlSideUI />
</aside>
<!-- /.Control Sidebar -->
<!-- Main Footer -->
<footer id="main-footer" class="main-footer">
    <FooterUI />
</footer>
<!-- /.Main Footer -->

<Update_PopUp @ref="refUpdate_PopUp"></Update_PopUp>
<VirusReport @ref="refVirusReport"></VirusReport>
<!--<SGCheckUpdate @ref="refSGCheckUpdate" OnClosePopUp="CloseCheckUpdate"></SGCheckUpdate>
<SGAvailableUpdate @ref="refSGAvailableUpdate" AppUpdaterSvc="@AppUpdaterSvc" CtrlSideUISvc="@CtrlSideUISvc" OnClosePopUp="CloseAvailableUpdate"></SGAvailableUpdate>
<SGDownloadUpdate @ref="refSGDownloadUpdate" CtrlSideUISvc="@CtrlSideUISvc" OnCancelDownloadUpdate="CancelDownloadUpdate"></SGDownloadUpdate>
<SGFinishedDownload @ref="refSGFinishedDownload" AppUpdaterSvc="@AppUpdaterSvc" CtrlSideUISvc="@CtrlSideUISvc" OnClosePopUp="CloseFinishedDownload"></SGFinishedDownload>
<SGMessageNotification @ref="refSGMessageNotification" CtrlSideUISvc="@CtrlSideUISvc" OnClosePopUp="CloseMessageNotification"></SGMessageNotification>-->
@code
{
    VirusReport refVirusReport;
    Update_PopUp refUpdate_PopUp;
    //SGNotiDownloadUpdate refSGNotiDownloadUpdate;
    ISGCtrlSideUIService CtrlSideUISvc;

    //SGCheckUpdate refSGCheckUpdate;
    //SGAvailableUpdate refSGAvailableUpdate;
    //SGDownloadUpdate refSGDownloadUpdate;
    //SGFinishedDownload refSGFinishedDownload;
    //SGMessageNotification refSGMessageNotification;

    protected override void OnInitialized()
    {
        CtrlSideUISvc = SGAppMgrSvc.CtrlSideUIService;
        HsCmdCenter.sgPageEvent.SetAPTAndVirusNotiEventAdd(AptAndVirusNoti);
        HsCmdCenter.sgPageEvent.SetClientUpgradeNotiEvent(UpdateNoti);
        //HsCmdCenter.sgPageEvent.SetClientUpgradeExeNotiEvent(clientUpgradeExe);
    }

    public async void AptAndVirusNoti(int groupID, eCmdList cmd, AptAndVirusEventArgs e)
    {
        string strTitle = XmlConf.GetNetworkTitle(groupID);
        //string strMsg = NotiMsgMake(cmd, e);
        string strFileTransTitle = e.strTitle;
        string strVirusContent = e.strMsg;
        string strTransSeq = e.strTransSeq;
        bool bVirus = false;
        if (cmd == eCmdList.eVIRUSSCAN)
            bVirus = true;
        refVirusReport.SetInit(groupID, strTransSeq, strFileTransTitle, strVirusContent, bVirus);
        await refVirusReport.openPopUp();

    }

    public async void UpdateNoti(PageEventArgs e)
    {
        string strSvrCliVersion = e.strMsg;
        if (strSvrCliVersion.Equals(""))
        {
            return;
        }
        string strCliVersion = HsCmdCenter.GetCliVersion();
        if (strCliVersion.Equals(""))
        {
            return;
        }

        strSvrCliVersion = strSvrCliVersion.ToUpper();
        strCliVersion = strCliVersion.ToUpper();
        if (String.Compare(strSvrCliVersion, strCliVersion, comparisonType: StringComparison.OrdinalIgnoreCase) > 0)
        //if(true)
        {
            string strSvrVersion = e.strMsg;
            refUpdate_PopUp.SetVersionText(strSvrCliVersion);
            refUpdate_PopUp.SetType(1);
            //refUpdate_PopUp.SetNotiUpdateEventAdd(NotiUpdateExe);
            await refUpdate_PopUp.openPopUp();
            //OpenDownloadUpdate();
        }
        else
            return;
    }

    public void NotiUpdateExe()
    {
        OpenDownloadUpdate();
    }
    private void OpenDownloadUpdate()
    {
        //refSGNotiDownloadUpdate.OpenPopUp("");
    }
    private void CloseDownloadUpdate()
    {
        //refSGNotiDownloadUpdate.ClosePopUp();
    }
    
    /*
    public async void CheckUpdatesClick()
    {
        await Task.Run(() =>
        {
            AppUpdaterSvc.CheckUpdatesClick(refSGCheckUpdate, refSGAvailableUpdate, refSGDownloadUpdate, refSGFinishedDownload, refSGMessageNotification);
        });
    }

    public void OpenCheckUpdate()
    {
        refSGCheckUpdate.OpenPopUp();
    }
    public void CloseCheckUpdate()
    {
        refSGCheckUpdate.ClosePopUp();
    }
    public void CloseAvailableUpdate()
    {
        refSGAvailableUpdate.ClosePopUp();
    }
    private void OpenDownloadUpdate(string downloadInfo)
    {
        refSGDownloadUpdate.OpenPopUp(downloadInfo);
    }
    private void CancelDownloadUpdate()
    {
        AppUpdaterSvc.SparkleInst.CancelFileDownload();
        AppUpdaterSvc.IsCancelRequested = true;
    }
    private void OpenFinishedDownload(string downloadInfo)
    {
        refSGFinishedDownload.OpenPopUp(downloadInfo);
    }
    private void CloseFinishedDownload()
    {
        refSGFinishedDownload.ClosePopUp();
    }
    public void OpenMessageNotification(string causeDescription)
    {
        refSGMessageNotification.OpenPopUp(causeDescription);
    }
    private void CloseMessageNotification()
    {
        refSGMessageNotification.ClosePopUp();
    }
    public void clientUpgradeExe()
    {
        CheckUpdatesClick();
    }
    */
    
}