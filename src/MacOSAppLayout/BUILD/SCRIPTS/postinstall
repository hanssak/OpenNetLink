#!/bin/zsh

#WHOAREYOU=`env | grep SUDO_USER | awk -F= '{print $2}'`
#echo $WHOAREYOU > /tmp/whoareyou-OpenNetLinkApp.log


REG_CRX=0
START_AUTO=1
NAME_CRX="gbbehmiepgfmmnifjbnknjaebgmnpbam.json"

WHOAREYOU=`last | head -1 | awk -F' ' '{ print $1 }'`
mkdir /Applications/OpenNetLinkApp.app/Contents/MacOS/wapprove

chown -R $WHOAREYOU /Applications/OpenNetLinkApp.app
chown -R :staff /Applications/OpenNetLinkApp.app
chmod -R g+w /Applications/OpenNetLinkApp.app

cd /Applications/OpenNetLinkApp.app/Contents/PlugIns
rm -rf /Applications/SecureGate.app

if [ -e $NETWORK_FILE ]; then    
    cp /tmp/Network.json /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/
    rm -rf /tmp/Network.json
fi

APPENV_FILE="/tmp/AppEnvSetting.json"
if [ -e $APPENV_FILE ]; then
    cp /tmp/AppEnvSetting.json /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/
    rm -rf /tmp/AppEnvSetting.json
fi

NETWORK_FILE="/Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/Network.json"
NETPOS=`cat $NETWORK_FILE | grep "NETPOS"` 

#NETPOS가 없는 Network.json의 경우에는 GroupID 개수로 파악
if [ -z "$NETPOS" ]; then
    NUMGROUPID=`cat $NETWORK_FILE | grep "GROUPID" | wc -l` 
    INT=$((NUMGROUPID))

    #그룹ID 개수가 1개 => 단일망 
    if [ ${INT} -le 1 ];then
        tar xvf SGFinderSync_IN.appex.tgz
    #그룹ID 개수가 2개 => 다중망
    else 
        tar xvf SGFinderSync_CN.appex.tgz
    fi  
else
    #NETPOS에는 IN/EX/CN 이 포함되어있음
    #해당 값 포함여부에 따라 압축 풀 대상 결정
    if [[ "${NETPOS}" == *"IN"* ]];then
        tar xvf SGFinderSync_IN.appex.tgz
    elif [[ "${NETPOS}" == *"EX"* ]];then
        tar xvf SGFinderSync_EX.appex.tgz
    elif [[ "${NETPOS}" == *"CN"* ]];then
        tar xvf SGFinderSync_CN.appex.tgz   
        
    #IN/EX/CN 모두 포함되어 있지 않다면 IN으로 실행
    else 
        tar xvf SGFinderSync_IN.appex.tgz
    fi  
fi

# json 파일복사로 Crx 파일 자동설치
if [ $REG_CRX -eq 1 ]; then

    #mkdir "$HOME/Library/Application Support/Google/Chrome/REG_CRX_TRUE_IN"
    #chown -R $WHOAREYOU "$HOME/Library/Application Support/Google/Chrome/REG_CRX_TRUE_IN"
    #chown -R :staff "$HOME/Library/Application Support/Google/Chrome/REG_CRX_TRUE_IN"
    #chmod -R g+w "$HOME/Library/Application Support/Google/Chrome/REG_CRX_TRUE_IN"

    if [ ! -d "$HOME/Library/Application Support/Google" ]; then
        mkdir "$HOME/Library/Application Support/Google"
        chown -R $WHOAREYOU "$HOME/Library/Application Support/Google"
        chown -R :staff "$HOME/Library/Application Support/Google"
        chmod -R g+w "$HOME/Library/Application Support/Google"
    fi

    if [ ! -d "$HOME/Library/Application Support/Google/Chrome" ]; then
        mkdir "$HOME/Library/Application Support/Google/Chrome"
        chown -R $WHOAREYOU "$HOME/Library/Application Support/Google/Chrome"
        chown -R :staff "$HOME/Library/Application Support/Google/Chrome"
        chmod -R g+w "$HOME/Library/Application Support/Google/Chrome"
    fi

    if [ ! -d "$HOME/Library/Application Support/Google/Chrome" ]; then
        mkdir "$HOME/Library/Application Support/Google/Chrome"
        chown -R $WHOAREYOU "$HOME/Library/Application Support/Google/Chrome"
        chown -R :staff "$HOME/Library/Application Support/Google/Chrome"
        chmod -R g+w "$HOME/Library/Application Support/Google/Chrome"
    fi

    mkdir "$HOME/Library/Application Support/Google/Chrome/External Extensions"
    chown -R $WHOAREYOU "$HOME/Library/Application Support/Google/Chrome/External Extensions"
    chown -R :staff "$HOME/Library/Application Support/Google/Chrome/External Extensions"
    chmod -R g+w "$HOME/Library/Application Support/Google/Chrome/External Extensions"

    #if [ ! -d "$HOME/Library/Application Support/Google/Chrome/External Extensions" ]; then
    #    mkdir "$HOME/Library/Application Support/Google/Chrome/External Extensions"
    #fi

    if [ ! -e "$HOME/Library/Application Support/Google/Chrome/External Extensions/$NAME_CRX" ]; then
        cp -f /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/bin_addon/chrome/$NAME_CRX "$HOME/Library/Application Support/Google/Chrome/External Extensions/$NAME_CRX"
        chown -R $WHOAREYOU "$HOME/Library/Application Support/Google/Chrome/External Extensions/$NAME_CRX"
        chown -R :staff "$HOME/Library/Application Support/Google/Chrome/External Extensions/$NAME_CRX"
        chmod -R g+w "$HOME/Library/Application Support/Google/Chrome/External Extensions/$NAME_CRX"
    fi
fi

#설치종료시 프로그램 바로 실행
if [ $START_AUTO -eq 1]; then
    open -a /Applications/OpenNetLinkApp.app
fi

exit 0
