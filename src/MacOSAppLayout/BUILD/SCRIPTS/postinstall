#!/bin/zsh

#WHOAREYOU=`env | grep SUDO_USER | awk -F= '{print $2}'`
#echo $WHOAREYOU > /tmp/whoareyou-OpenNetLinkApp.log

#Update Confirm 
UPDATE_CHECK=false
START_AUTO=false
INSTALL_PATH="/Applications/OpenNetLinkApp.app"
FILE_INSTALL_PATH="/Applications/OpenNetLinkApp.app/Contents/MacOS"
file="/Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/temp/UpdateFileList.txt"



REG_CRX=true
NAME_CRX="gbbehmiepgfmmnifjbnknjaebgmnpbam.json"

WHOAREYOU=`last | head -1 | awk -F' ' '{ print $1 }'`
mkdir /Applications/OpenNetLinkApp.app/Contents/MacOS/wapprove

cd /Applications/OpenNetLinkApp.app/Contents/PlugIns
rm -rf /Applications/SecureGate.app

if [ $UPDATE_CHECK ]; then
    while read -r line
    do
        if [ ! -e "$FILE_INSTALL_PATH/$line" ]; then
            
            printf "FAIL/$(date +%Y)-$(date +%m)-$(date +%d) $(date +%H):$(date +%M):$(date +%S)/FILE['$line'] is missing." > /tmp/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/UpdateResult.txt
            rm -rf "$INSTALL_PATH/Contents"
            cp -rf /tmp/OpenNetLinkApp.app/Contents /Applications/OpenNetLinkApp.app
            if [ -d "$INSTALL_PATH/Contents/MacOS/wwwroot" ]; then
                rm -rf "$INSTALL_PATH/Contents/MacOS/wwwroot"
                ln -s "$INSTALL_PATH/Contents/Resources/wwwroot" "/$INSTALL_PATH/Contents/MacOS"
            fi
            rm -rf "/tmp/OpenNetLinkApp.app"

            exit 0;
        fi 
    done <"$file"

    #성공한 경우, Network/Env/DB/Log 는 기존 데이터로 복원
    LOG_DIR="/tmp/OpenNetLinkApp.app/Contents/Resources/wwwroot/Log"
    NETWORK_FILE="/tmp/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/Network.json"
    APPENV_FILE="/tmp/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/AppEnvSetting.json"
    NOTIDB_FILE="/tmp/OpenNetLinkApp.app/Contents/Resources/wwwroot/db/SGNotifyDB.db"
    SETTINGDB_FILE="/tmp/OpenNetLinkApp.app/Contents/Resources/wwwroot/db/SGSettingsDB.db"
    HSCK_FILE="/tmp/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/hsck"
    printf "SUCCESS/$(date +%Y)-$(date +%m)-$(date +%d) $(date +%H):$(date +%M):$(date +%S)" > /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/UpdateResult.txt
else
    LOG_DIR=""
    NETWORK_FILE="/tmp/Network.json"
    APPENV_FILE="/tmp/AppEnvSetting.json"
    NOTIDB_FILE="/tmp/SGNotifyDB.db"
    SETTINGDB_FILE="/tmp/SGSettingsDB.db"
    HSCK_FILE="/tmp/hsck"
fi

#Network/Env/DB/Log 는 기존 데이터로 복원
if [ -e $LOG_DIR ]; then    
    cp -r $LOG_DIR /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot
    rm -rf $LOG_DIR
fi

if [ -e $NETWORK_FILE ]; then    
    cp $NETWORK_FILE /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/
    rm -rf $NETWORK_FILE
fi

if [ -e $APPENV_FILE ]; then    
    cp $APPENV_FILE /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/
    rm -rf $APPENV_FILE
fi

if [ -e $NOTIDB_FILE ]; then
    cp $NOTIDB_FILE /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/db/
    rm -rf $NOTIDB_FILE
fi

if [ -e $SETTINGDB_FILE ]; then
    cp $SETTINGDB_FILE /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/db/
    rm -rf $SETTINGDB_FILE
fi

if [ -e $HSCK_FILE ]; then
    cp $HSCK_FILE /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/
    rm -rf $HSCK_FILE
fi

if [ -d "/Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/temp" ]; then
    rm -rf "/Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/temp"
fi

chown -R $WHOAREYOU /Applications/OpenNetLinkApp.app
chown -R :staff /Applications/OpenNetLinkApp.app
chmod -R g+w /Applications/OpenNetLinkApp.app

rm -rf "/tmp/OpenNetLinkApp.app"

NETWORK_FILE="/Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/Network.json"
NETPOS=`cat $NETWORK_FILE | grep "NETPOS"` 

#NETPOS가 없는 Network.json의 경우에는 GroupID 개수로 파악
if [ -z "$NETPOS" ]; then
    NUMGROUPID=`cat $NETWORK_FILE | grep "GROUPID" | wc -l` 
    INT=$((NUMGROUPID))

    #그룹ID 개수가 1개 => 단일망 
    if [ ${INT} -le 1 ];then
        tar xvf SGFinderSync_IN.appex.tgz
    #그룹ID 개수가 2개 => 다중망
    else 
        tar xvf SGFinderSync_CN.appex.tgz
    fi  
else
    #NETPOS에는 IN/EX/CN 이 포함되어있음
    #해당 값 포함여부에 따라 압축 풀 대상 결정
    if [[ "${NETPOS}" == *"IN"* ]];then
        tar xvf SGFinderSync_IN.appex.tgz
    elif [[ "${NETPOS}" == *"EX"* ]];then
        tar xvf SGFinderSync_EX.appex.tgz
    elif [[ "${NETPOS}" == *"CN"* ]];then
        tar xvf SGFinderSync_CN.appex.tgz   
        
    #IN/EX/CN 모두 포함되어 있지 않다면 IN으로 실행
    else 
        tar xvf SGFinderSync_IN.appex.tgz
    fi  
fi

# json 파일복사로 Crx 파일 자동설치
testVal=-1 # 1 : 동작, -1 : 미동작
if [ $testVal -gt 0 ] && [[ "${NETPOS}" == *"IN"* ]]; then

    #mkdir "$HOME/Library/Application Support/Google/Chrome/REG_CRX_TRUE_IN"
    #chown -R $WHOAREYOU "$HOME/Library/Application Support/Google/Chrome/REG_CRX_TRUE_IN"
    #chown -R :staff "$HOME/Library/Application Support/Google/Chrome/REG_CRX_TRUE_IN"
    #chmod -R g+w "$HOME/Library/Application Support/Google/Chrome/REG_CRX_TRUE_IN"

    if [ ! -d "$HOME/Library/Application Support/Google" ]; then
        mkdir "$HOME/Library/Application Support/Google"
        chown -R $WHOAREYOU "$HOME/Library/Application Support/Google"
        chown -R :staff "$HOME/Library/Application Support/Google"
        chmod -R g+w "$HOME/Library/Application Support/Google"
    fi

    if [ ! -d "$HOME/Library/Application Support/Google/Chrome" ]; then
        mkdir "$HOME/Library/Application Support/Google/Chrome"
        chown -R $WHOAREYOU "$HOME/Library/Application Support/Google/Chrome"
        chown -R :staff "$HOME/Library/Application Support/Google/Chrome"
        chmod -R g+w "$HOME/Library/Application Support/Google/Chrome"
    fi

    if [ ! -d "$HOME/Library/Application Support/Google/Chrome" ]; then
        mkdir "$HOME/Library/Application Support/Google/Chrome"
        chown -R $WHOAREYOU "$HOME/Library/Application Support/Google/Chrome"
        chown -R :staff "$HOME/Library/Application Support/Google/Chrome"
        chmod -R g+w "$HOME/Library/Application Support/Google/Chrome"
    fi

    mkdir "$HOME/Library/Application Support/Google/Chrome/External Extensions"
    chown -R $WHOAREYOU "$HOME/Library/Application Support/Google/Chrome/External Extensions"
    chown -R :staff "$HOME/Library/Application Support/Google/Chrome/External Extensions"
    chmod -R g+w "$HOME/Library/Application Support/Google/Chrome/External Extensions"

    #if [ ! -d "$HOME/Library/Application Support/Google/Chrome/External Extensions" ]; then
    #    mkdir "$HOME/Library/Application Support/Google/Chrome/External Extensions"
    #fi

    if [ ! -e "$HOME/Library/Application Support/Google/Chrome/External Extensions/$NAME_CRX" ]; then
        cp -f /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/bin_addon/chrome/$NAME_CRX "$HOME/Library/Application Support/Google/Chrome/External Extensions/$NAME_CRX"
        chown -R $WHOAREYOU "$HOME/Library/Application Support/Google/Chrome/External Extensions/$NAME_CRX"
        chown -R :staff "$HOME/Library/Application Support/Google/Chrome/External Extensions/$NAME_CRX"
        chmod -R g+w "$HOME/Library/Application Support/Google/Chrome/External Extensions/$NAME_CRX"
    fi
fi




#설치종료시 프로그램 바로 실행
if [ ! $START_AUTO ]; then
    open -a /Applications/OpenNetLinkApp.app
fi

exit 0
