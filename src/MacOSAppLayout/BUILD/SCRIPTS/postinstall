#!/bin/zsh

#WHOAREYOU=`env | grep SUDO_USER | awk -F= '{print $2}'`
#echo $WHOAREYOU > /tmp/whoareyou-OpenNetLinkApp.log

#Update Confirm 
UPDATE_CHECK=true
START_AUTO=false
INSTALL_PATH="/Applications/OpenNetLinkApp.app"
FILE_INSTALL_PATH="/Applications/OpenNetLinkApp.app/Contents/MacOS"
file="/Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/temp/UpdateFileList.txt"

if [ ! $UPDATE_CHECK ]; then
    while read -r line
    do
        if [ ! -e "$FILE_INSTALL_PATH/$line" ]; then
            #echo "FilePath $FILE_INSTALL_PATH/$line"
            printf "Update Fail $FILE_INSTALL_PATH/$line" > /tmp/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/UpdateResult.txt
            rm -rf "$INSTALL_PATH/Contents"
            cp -rf /tmp/OpenNetLinkApp.app/Contents /Applications/OpenNetLinkApp.app
            if [ -d "$INSTALL_PATH/Contents/MacOS/wwwroot" ]; then
                rm -rf "$INSTALL_PATH/Contents/MacOS/wwwroot"
                ln -s "$INSTALL_PATH/Contents/Resources/wwwroot" "/$INSTALL_PATH/Contents/MacOS"
            fi
            rm -rf "/tmp/OpenNetLinkApp.app"

            exit 0;
        fi 
    done <"$file"

    rm -rf "/tmp/OpenNetLinkApp.app"
    printf "Update Good!!" > /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/UpdateResult.txt

fi

if [ -d "/Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/temp" ]; then
    rm -rf "/Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/temp"
fi



WHOAREYOU=`last | head -1 | awk -F' ' '{ print $1 }'`
mkdir /Applications/OpenNetLinkApp.app/Contents/MacOS/wapprove

chown -R $WHOAREYOU /Applications/OpenNetLinkApp.app
chown -R :staff /Applications/OpenNetLinkApp.app
chmod -R g+w /Applications/OpenNetLinkApp.app

cd /Applications/OpenNetLinkApp.app/Contents/PlugIns
rm -rf /Applications/SecureGate.app

if [ -e $NETWORK_FILE ]; then    
    cp /tmp/Network.json /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/
    rm -rf /tmp/Network.json
fi

APPENV_FILE="/tmp/AppEnvSetting.json"
if [ -e $APPENV_FILE ]; then
    cp /tmp/AppEnvSetting.json /Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/
    rm -rf /tmp/AppEnvSetting.json
fi

    NETWORK_FILE="/Applications/OpenNetLinkApp.app/Contents/Resources/wwwroot/conf/Network.json"
    NETPOS=`cat $NETWORK_FILE | grep "NETPOS"` 

    #NETPOS가 없는 Network.json의 경우에는 GroupID 개수로 파악
    if [ -z "$NETPOS" ]; then
        NUMGROUPID=`cat $NETWORK_FILE | grep "GROUPID" | wc -l` 
        INT=$((NUMGROUPID))

        #그룹ID 개수가 1개 => 단일망 
        if [ ${INT} -le 1 ];then
            tar xvf SGFinderSync_IN.appex.tgz
        #그룹ID 개수가 2개 => 다중망
        else 
            tar xvf SGFinderSync_CN.appex.tgz
        fi  
    else
        #NETPOS에는 IN/EX/CN 이 포함되어있음
        #해당 값 포함여부에 따라 압축 풀 대상 결정
        if [[ "${NETPOS}" == *"IN"* ]];then
            tar xvf SGFinderSync_IN.appex.tgz
        elif [[ "${NETPOS}" == *"EX"* ]];then
            tar xvf SGFinderSync_EX.appex.tgz
        elif [[ "${NETPOS}" == *"CN"* ]];then
            tar xvf SGFinderSync_CN.appex.tgz   
            
        #IN/EX/CN 모두 포함되어 있지 않다면 IN으로 실행
        else 
            tar xvf SGFinderSync_IN.appex.tgz
        fi  
    fi

#설치종료시 프로그램 바로 실행
if [ ! $START_AUTO ]; then
    open -a /Applications/OpenNetLinkApp.app
fi

exit 0
